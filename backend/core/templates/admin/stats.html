{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Äî BoltPromo{% endblock %}

{% block extrastyle %}
<style>
    .stats-container {
        padding: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
        margin-top: 20px;
    }

    @media (min-width: 1024px) {
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .chart-card {
        background: #252932;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
        border: 1px solid #3f4451;
    }

    .chart-card h3 {
        margin-top: 0;
        color: #F3F4F6;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #3B82F6;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
    }

    .loading {
        text-align: center;
        color: #9CA3AF;
        padding: 40px;
    }

    .range-selector {
        margin-bottom: 24px;
        padding: 16px;
        background: #252932;
        border-radius: 10px;
        border: 2px solid #3f4451;
    }

    .range-selector label {
        color: #E5E7EB;
        font-weight: 600;
        margin-right: 12px;
    }

    .range-selector select {
        padding: 10px 16px;
        border: 2px solid #3f4451;
        border-radius: 8px;
        font-size: 14px;
        background-color: #2d3139;
        color: #F3F4F6;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .range-selector select:focus {
        border-color: #3B82F6;
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .error-message {
        background: rgba(239, 68, 68, 0.1);
        color: #FCA5A5;
        padding: 16px 20px;
        border-radius: 12px;
        margin: 12px 0;
        border-left: 4px solid #EF4444;
    }

    .empty-message {
        text-align: center;
        color: #9CA3AF;
        padding: 60px 20px;
        background: #252932;
        border-radius: 12px;
        border: 2px dashed #3f4451;
    }

    .empty-message .icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .info-box {
        background: rgba(59, 130, 246, 0.1);
        color: #93C5FD;
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        border-left: 4px solid #3B82F6;
    }

    .info-box strong {
        color: #60A5FA;
    }

    /* –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .stats-header {
        margin-bottom: 32px;
    }

    .stats-header h1 {
        color: #F3F4F6;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .stats-header p {
        color: #9CA3AF;
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <div class="stats-header">
        <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ BoltPromo</h1>
        <p>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    </div>

    <div class="info-box">
        <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
        –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É API endpoints.
        <a href="{% url 'admin_reaggregate' %}" style="margin-left: 20px; padding: 6px 12px; background: #48bb78; color: white; text-decoration: none; border-radius: 4px; font-size: 13px;">
            <i class="fas fa-sync-alt"></i> –ü–µ—Ä–µ–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
        </a>
    </div>

    <div id="global-error" class="error-message" style="display: none;"></div>

    <div class="range-selector">
        <label for="range">–ü–µ—Ä–∏–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
        <select id="range" onchange="loadAllCharts()">
            <option value="7d" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
            <option value="14d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</option>
            <option value="30d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
        </select>
    </div>

    <div class="stats-grid">
        <div class="chart-card">
            <h3>üî• –¢–æ–ø-10 –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –ø–æ –∫–ª–∏–∫–∞–º</h3>
            <div class="chart-wrapper">
                <canvas id="topPromosChart"></canvas>
                <div id="topPromosEmpty" class="empty-message" style="display: none;">
                    <div class="icon">üìä</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                </div>
            </div>
        </div>

        <div class="chart-card">
            <h3>üè™ –¢–æ–ø-10 –º–∞–≥–∞–∑–∏–Ω–æ–≤</h3>
            <div class="chart-wrapper">
                <canvas id="topStoresChart"></canvas>
                <div id="topStoresEmpty" class="empty-message" style="display: none;">
                    <div class="icon">üè™</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                </div>
            </div>
        </div>

        <div class="chart-card">
            <h3>üì¶ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –æ—Ñ—Ñ–µ—Ä–æ–≤</h3>
            <div class="chart-wrapper">
                <canvas id="typesShareChart"></canvas>
                <div id="typesShareEmpty" class="empty-message" style="display: none;">
                    <div class="icon">üì¶</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                </div>
            </div>
        </div>

        <div class="chart-card">
            <h3>üéØ CTR –≤–∏—Ç—Ä–∏–Ω (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã/–∫–ª–∏–∫–∏)</h3>
            <div class="chart-wrapper">
                <canvas id="showcasesCTRChart"></canvas>
                <div id="showcasesCTREmpty" class="empty-message" style="display: none;">
                    <div class="icon">üéØ</div>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
let charts = {};

function showError(message) {
    const errorDiv = document.getElementById('global-error');
    errorDiv.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 10000);
}

function hideError() {
    const errorDiv = document.getElementById('global-error');
    errorDiv.style.display = 'none';
}

async function loadAllCharts() {
    const range = document.getElementById('range').value;
    hideError();
    await Promise.all([
        loadTopPromos(range),
        loadTopStores(range),
        loadTypesShare(range),
        loadShowcasesCTR(range)
    ]);
}

async function loadTopPromos(range) {
    const canvasId = 'topPromosChart';
    const emptyId = 'topPromosEmpty';

    try {
        const response = await fetch(`/api/v1/stats/top-promos/?range=${range}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data || data.length === 0) {
            document.getElementById(canvasId).style.display = 'none';
            document.getElementById(emptyId).style.display = 'flex';
            return;
        }

        document.getElementById(canvasId).style.display = 'block';
        document.getElementById(emptyId).style.display = 'none';

        const ctx = document.getElementById(canvasId);

        if (charts.topPromos) {
            charts.topPromos.destroy();
        }

        charts.topPromos = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.title.substring(0, 30)),
                datasets: [{
                    label: '–ö–ª–∏–∫–∏',
                    data: data.map(item => item.clicks),
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#E5E7EB' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    },
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading top promos:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ø –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API endpoint /api/v1/stats/top-promos/');
        document.getElementById(canvasId).style.display = 'none';
        document.getElementById(emptyId).style.display = 'flex';
    }
}

async function loadTopStores(range) {
    const canvasId = 'topStoresChart';
    const emptyId = 'topStoresEmpty';

    try {
        const response = await fetch(`/api/v1/stats/top-stores/?range=${range}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data || data.length === 0) {
            document.getElementById(canvasId).style.display = 'none';
            document.getElementById(emptyId).style.display = 'flex';
            return;
        }

        document.getElementById(canvasId).style.display = 'block';
        document.getElementById(emptyId).style.display = 'none';

        const ctx = document.getElementById(canvasId);

        if (charts.topStores) {
            charts.topStores.destroy();
        }

        charts.topStores = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.name),
                datasets: [{
                    label: '–ö–ª–∏–∫–∏',
                    data: data.map(item => item.clicks),
                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        labels: { color: '#E5E7EB' }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    },
                    y: {
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading top stores:', error);
        document.getElementById(canvasId).style.display = 'none';
        document.getElementById(emptyId).style.display = 'flex';
    }
}

async function loadTypesShare(range) {
    const canvasId = 'typesShareChart';
    const emptyId = 'typesShareEmpty';

    try {
        const response = await fetch(`/api/v1/stats/types-share/?range=${range}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data || data.length === 0) {
            document.getElementById(canvasId).style.display = 'none';
            document.getElementById(emptyId).style.display = 'flex';
            return;
        }

        document.getElementById(canvasId).style.display = 'block';
        document.getElementById(emptyId).style.display = 'none';

        const ctx = document.getElementById(canvasId);

        if (charts.typesShare) {
            charts.typesShare.destroy();
        }

        const typeLabels = {
            'coupon': '–ü—Ä–æ–º–æ–∫–æ–¥',
            'deal': '–°–∫–∏–¥–∫–∞',
            'financial': '–§–∏–Ω–∞–Ω—Å—ã',
            'cashback': '–ö—ç—à–±—ç–∫'
        };

        charts.typesShare = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(item => typeLabels[item.type] || item.type),
                datasets: [{
                    data: data.map(item => item.count),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(139, 92, 246, 0.7)'
                    ],
                    borderWidth: 2,
                    borderColor: '#252932'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#E5E7EB', padding: 15 }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading types share:', error);
        document.getElementById(canvasId).style.display = 'none';
        document.getElementById(emptyId).style.display = 'flex';
    }
}

async function loadShowcasesCTR(range) {
    const canvasId = 'showcasesCTRChart';
    const emptyId = 'showcasesCTREmpty';

    try {
        const response = await fetch(`/api/v1/stats/showcases-ctr/?range=${range}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data || data.length === 0) {
            document.getElementById(canvasId).style.display = 'none';
            document.getElementById(emptyId).style.display = 'flex';
            return;
        }

        document.getElementById(canvasId).style.display = 'block';
        document.getElementById(emptyId).style.display = 'none';

        const ctx = document.getElementById(canvasId);

        if (charts.showcasesCTR) {
            charts.showcasesCTR.destroy();
        }

        charts.showcasesCTR = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.title.substring(0, 20)),
                datasets: [
                    {
                        label: '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã',
                        data: data.map(item => item.views),
                        backgroundColor: 'rgba(156, 163, 175, 0.6)',
                        borderColor: 'rgba(156, 163, 175, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '–ö–ª–∏–∫–∏',
                        data: data.map(item => item.clicks),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#E5E7EB' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    },
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading showcases CTR:', error);
        document.getElementById(canvasId).style.display = 'none';
        document.getElementById(emptyId).style.display = 'flex';
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadAllCharts();
});
</script>
{% endblock %}
